{% extends 'base.html' %}

{% block title %}Cast Your Vote - Local Elections{% endblock %}

{% block extra_css %}
<style>
    .vote-header {
        background: var(--gradient-primary);
        color: white;
        padding: 2.5rem 0;
        margin-top: -2rem;
        margin-bottom: 2rem;
    }
    
    .location-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        display: inline-block;
        margin-top: 0.5rem;
    }
    
    .section-card {
        border-left: 4px solid var(--color-primary);
    }
    
    .section-card .card-header {
        background: white;
        color: var(--color-primary);
        border-bottom: 2px solid #e9ecef;
    }
    
    .candidate-card {
        border: 2px solid #e9ecef;
        border-radius: var(--border-radius);
        padding: 1.25rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
    }
    
    .candidate-card:hover {
        border-color: var(--color-primary);
        background: #f8f9fa;
    }
    
    .candidate-card.selected {
        border-color: var(--color-primary);
        background: linear-gradient(135deg, #e8f4fc 0%, #d4e9f7 100%);
        box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.15);
    }
    
    .candidate-card input[type="radio"] {
        display: none;
    }
    
    .candidate-info {
        display: flex;
        align-items: center;
    }
    
    .candidate-avatar {
        width: 60px;
        height: 60px;
        background: var(--color-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .candidate-details h5 {
        margin-bottom: 0.25rem;
        font-weight: 600;
    }
    
    .candidate-details .party {
        color: var(--color-muted);
        font-size: 0.9rem;
    }
    
    .candidate-details .symbol {
        background: var(--color-light);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        display: inline-block;
        margin-top: 0.25rem;
    }
    
    .check-indicator {
        width: 30px;
        height: 30px;
        border: 2px solid #dee2e6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: auto;
        flex-shrink: 0;
    }
    
    .candidate-card.selected .check-indicator {
        background: var(--color-success);
        border-color: var(--color-success);
        color: white;
    }
    
    .ward-section {
        display: none;
    }
    
    .ward-section.active {
        display: block;
    }
    
    .ward-candidates-container {
        display: none;
    }
    
    .ward-candidates-container.active {
        display: block;
    }
    
    .mobile-section {
        background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .mobile-section .privacy-notice {
        font-size: 0.85rem;
        color: #664d03;
        margin-top: 0.5rem;
    }
    
    .submit-section {
        background: var(--color-light);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .vote-summary {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .vote-summary-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .vote-summary-item:last-child {
        border-bottom: none;
    }
    
    .vote-summary-label {
        color: var(--color-muted);
    }
    
    .vote-summary-value {
        font-weight: 600;
    }
    
    .no-candidates {
        text-align: center;
        padding: 2rem;
        color: var(--color-muted);
    }
    
    .no-candidates i {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
    }
    
    .candidate-promises {
        background: rgba(25, 135, 84, 0.05);
        border-left: 3px solid var(--color-success);
        padding: 0.5rem 0.75rem;
        border-radius: 0 6px 6px 0;
        margin-top: 0.5rem;
    }
    
    .candidate-promises ul li {
        padding: 0.15rem 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<section class="vote-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="mb-2">
                    <i class="bi bi-check2-square me-2"></i>Cast Your Vote
                </h1>
                <div class="location-badge">
                    <i class="bi bi-geo-alt me-1"></i>
                    {{ village.full_location }}
                </div>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                <span class="badge bg-success px-3 py-2">
                    <i class="bi bi-broadcast me-1"></i>
                    {{ election.name }}
                </span>
            </div>
        </div>
    </div>
</section>

<div class="container">
    <form method="post" id="voteForm">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Sarpanch Section -->
                <div class="card section-card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-person-badge me-2"></i>
                            Vote for Sarpanch
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Select ONE candidate for the position of Village Sarpanch (Head)
                        </p>
                        
                        {% if sarpanch_candidates %}
                        <div class="candidates-list">
                            {% for candidate in sarpanch_candidates %}
                            <label class="candidate-card" data-candidate-id="{{ candidate.id }}">
                                <input type="radio" name="sarpanch_candidate" value="{{ candidate.id }}" required>
                                <div class="candidate-info">
                                    <div class="candidate-avatar">
                                        {{ candidate.full_name|slice:":1" }}
                                    </div>
                                    <div class="candidate-details">
                                        <h5>{{ candidate.full_name }}</h5>
                                        <span class="party">
                                            {% if candidate.party_name %}
                                            {{ candidate.party_name }}
                                            {% else %}
                                            Independent
                                            {% endif %}
                                        </span>
                                        {% if candidate.symbol %}
                                        <span class="symbol">
                                            <i class="bi bi-star me-1"></i>{{ candidate.symbol }}
                                        </span>
                                        {% endif %}
                                        {% if candidate.promises_list %}
                                        <div class="candidate-promises mt-2">
                                            <small class="text-muted d-block mb-1">
                                                <i class="bi bi-card-checklist me-1"></i>Promises / Welfare Activities:
                                            </small>
                                            <ul class="list-unstyled mb-0 ps-3">
                                                {% for promise in candidate.promises_list %}
                                                <li class="small text-muted">
                                                    <i class="bi bi-check-circle-fill text-success me-1"></i>{{ promise }}
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="check-indicator">
                                        <i class="bi bi-check2"></i>
                                    </div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="no-candidates">
                            <i class="bi bi-person-x"></i>
                            <p>No Sarpanch candidates registered for this village.</p>
                        </div>
                        {% endif %}
                        
                        {% if form.sarpanch_candidate.errors %}
                        <div class="alert alert-danger mt-3">
                            {{ form.sarpanch_candidate.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Ward Selection Section -->
                <div class="card section-card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-grid-3x3-gap me-2"></i>
                            Select Your Ward
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Select your ward to see Ward Member candidates
                        </p>
                        
                        <select name="ward" id="ward-select" class="form-select form-select-lg" required>
                            <option value="">-- Select Your Ward --</option>
                            {% for ward in wards %}
                            <option value="{{ ward.id }}">
                                Ward {{ ward.number }}{% if ward.name %} - {{ ward.name }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        
                        {% if form.ward.errors %}
                        <div class="alert alert-danger mt-3">
                            {{ form.ward.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Ward Member Section -->
                <div class="card section-card mb-4 ward-section" id="wardMemberSection">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="bi bi-people me-2"></i>
                            Vote for Ward Member
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Select ONE candidate for Ward Member position
                        </p>
                        
                        <div id="wardCandidatesContainer">
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-arrow-up-circle" style="font-size: 2rem;"></i>
                                <p class="mt-2">Please select your ward above to see candidates</p>
                            </div>
                        </div>
                        
                        {% if form.ward_member_candidate.errors %}
                        <div class="alert alert-danger mt-3">
                            {{ form.ward_member_candidate.errors }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Mobile Number Section -->
                <div class="mobile-section">
                    <h5 class="mb-3">
                        <i class="bi bi-phone me-2"></i>
                        Verify Your Identity
                    </h5>
                    <div class="mb-3">
                        <label for="mobile_number" class="form-label">Mobile Number</label>
                        <input type="tel" 
                               name="mobile_number" 
                               id="mobile_number" 
                               class="form-control form-control-lg {% if form.mobile_number.errors %}is-invalid{% endif %}"
                               placeholder="Enter 10-digit mobile number"
                               pattern="[6-9][0-9]{9}"
                               inputmode="numeric"
                               maxlength="10"
                               required
                               value="{{ form.mobile_number.value|default:'' }}">
                        {% if form.mobile_number.errors %}
                        <div class="invalid-feedback">
                            {{ form.mobile_number.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    <p class="privacy-notice mb-0">
                        <i class="bi bi-shield-lock me-1"></i>
                        Your mobile number is used only to ensure one-person-one-vote and will not be publicly exposed.
                    </p>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 1rem;">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-clipboard-check me-2"></i>
                            Vote Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="vote-summary">
                            <div class="vote-summary-item">
                                <span class="vote-summary-label">Location</span>
                                <span class="vote-summary-value">{{ village.name }}</span>
                            </div>
                            <div class="vote-summary-item">
                                <span class="vote-summary-label">Sarpanch</span>
                                <span class="vote-summary-value" id="summaryStarpanch">Not selected</span>
                            </div>
                            <div class="vote-summary-item">
                                <span class="vote-summary-label">Ward</span>
                                <span class="vote-summary-value" id="summaryWard">Not selected</span>
                            </div>
                            <div class="vote-summary-item">
                                <span class="vote-summary-label">Ward Member</span>
                                <span class="vote-summary-value" id="summaryWardMember">Not selected</span>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="submitVoteBtn">
                                <i class="bi bi-check2-circle me-2"></i>Submit Vote
                            </button>
                            <a href="{% url 'elections:select_location' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Change Location
                            </a>
                        </div>
                        
                        <div class="alert alert-info mt-3 mb-0">
                            <small>
                                <i class="bi bi-info-circle me-1"></i>
                                Please review your selections carefully before submitting. 
                                You cannot change your vote once submitted.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Candidate card selection
    document.querySelectorAll('.candidate-card').forEach(card => {
        card.addEventListener('click', function() {
            // Get parent section
            const section = this.closest('.candidates-list') || this.closest('#wardCandidatesContainer');
            
            // Remove selected from siblings
            section.querySelectorAll('.candidate-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Add selected to clicked card
            this.classList.add('selected');
            
            // Check the radio
            const radio = this.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
            }
            
            // Update summary
            updateSummary();
        });
    });
    
    // Ward selection
    const wardSelect = document.getElementById('ward-select');
    const wardMemberSection = document.getElementById('wardMemberSection');
    const wardCandidatesContainer = document.getElementById('wardCandidatesContainer');
    
    wardSelect.addEventListener('change', function() {
        const wardId = this.value;
        
        if (wardId) {
            // Show ward member section
            wardMemberSection.classList.add('ward-section', 'active');
            wardMemberSection.style.display = 'block';
            
            // Update summary
            document.getElementById('summaryWard').textContent = 
                wardSelect.options[wardSelect.selectedIndex].text;
            
            // Fetch ward candidates
            fetch(`{% url 'elections:ajax_load_ward_candidates' %}?ward_id=${wardId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        let html = '<div class="candidates-list">';
                        data.forEach(candidate => {
                            html += `
                                <label class="candidate-card" data-candidate-id="${candidate.id}">
                                    <input type="radio" name="ward_member_candidate" value="${candidate.id}" required>
                                    <div class="candidate-info">
                                        <div class="candidate-avatar">
                                            ${candidate.full_name.charAt(0)}
                                        </div>
                                        <div class="candidate-details">
                                            <h5>${candidate.full_name}</h5>
                                            <span class="party">${candidate.party_name}</span>
                                            ${candidate.symbol !== '-' ? `<span class="symbol"><i class="bi bi-star me-1"></i>${candidate.symbol}</span>` : ''}
                                        </div>
                                        <div class="check-indicator">
                                            <i class="bi bi-check2"></i>
                                        </div>
                                    </div>
                                </label>
                            `;
                        });
                        html += '</div>';
                        wardCandidatesContainer.innerHTML = html;
                        
                        // Add click handlers to new cards
                        wardCandidatesContainer.querySelectorAll('.candidate-card').forEach(card => {
                            card.addEventListener('click', function() {
                                wardCandidatesContainer.querySelectorAll('.candidate-card').forEach(c => {
                                    c.classList.remove('selected');
                                });
                                this.classList.add('selected');
                                this.querySelector('input[type="radio"]').checked = true;
                                updateSummary();
                            });
                        });
                    } else {
                        wardCandidatesContainer.innerHTML = `
                            <div class="no-candidates">
                                <i class="bi bi-person-x"></i>
                                <p>No Ward Member candidates registered for this ward.</p>
                            </div>
                        `;
                    }
                });
        } else {
            wardMemberSection.classList.remove('active');
            wardMemberSection.style.display = 'none';
            document.getElementById('summaryWard').textContent = 'Not selected';
            document.getElementById('summaryWardMember').textContent = 'Not selected';
        }
    });
    
    // Update vote summary
    function updateSummary() {
        // Sarpanch
        const sarpanchSelected = document.querySelector('input[name="sarpanch_candidate"]:checked');
        if (sarpanchSelected) {
            const card = sarpanchSelected.closest('.candidate-card');
            const name = card.querySelector('.candidate-details h5').textContent;
            document.getElementById('summaryStarpanch').textContent = name;
        }
        
        // Ward Member
        const wardMemberSelected = document.querySelector('input[name="ward_member_candidate"]:checked');
        if (wardMemberSelected) {
            const card = wardMemberSelected.closest('.candidate-card');
            const name = card.querySelector('.candidate-details h5').textContent;
            document.getElementById('summaryWardMember').textContent = name;
        }
    }
    
    // Mobile number formatting
    const mobileInput = document.getElementById('mobile_number');
    mobileInput.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').slice(0, 10);
    });
    
    // Form validation
    document.getElementById('voteForm').addEventListener('submit', function(e) {
        const sarpanch = document.querySelector('input[name="sarpanch_candidate"]:checked');
        const ward = document.getElementById('ward-select').value;
        const wardMember = document.querySelector('input[name="ward_member_candidate"]:checked');
        const mobile = document.getElementById('mobile_number').value;
        
        if (!sarpanch) {
            e.preventDefault();
            alert('Please select a Sarpanch candidate.');
            return false;
        }
        
        if (!ward) {
            e.preventDefault();
            alert('Please select your ward.');
            return false;
        }
        
        if (!wardMember) {
            e.preventDefault();
            alert('Please select a Ward Member candidate.');
            return false;
        }
        
        if (!mobile || mobile.length !== 10) {
            e.preventDefault();
            alert('Please enter a valid 10-digit mobile number.');
            return false;
        }
        
        // Confirm submission
        if (!confirm('Are you sure you want to submit your vote? This action cannot be undone.')) {
            e.preventDefault();
            return false;
        }
    });
</script>
{% endblock %}

